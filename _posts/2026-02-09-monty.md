---
layout: post
title: "Monty"
subtitle: "Trình thông dịch Python siêu tốc, bảo mật viết bằng Rust giúp thực thi code do AI sinh ra an toàn mà không cần Docker."
tags: [github]
---

## Giới thiệu

Monty (của Pydantic) là một trình thông dịch Python thu nhỏ (subset) được viết bằng Rust, được thiết kế đặc biệt để giải quyết bài toán an toàn khi chạy code do AI (LLM) sinh ra. Bình thường, để chạy code không tin cậy, developer phải dùng Docker container (chậm, nặng) hoặc WebAssembly. Monty giải quyết vấn đề này bằng cách cung cấp một môi trường sandbox ngay ở cấp độ thông dịch viên, khởi động cực nhanh (micro-seconds) và mặc định chặn mọi truy cập nguy hiểm (file hệ thống, mạng). Đây là công cụ lý tưởng cho các AI Agent cần khả năng 'Code Interpreter' mạnh mẽ và an toàn.

## Tính năng chính

- **Sandboxing mặc định**: Ngăn chặn hoàn toàn việc truy cập filesystem, biến môi trường và mạng trừ khi được cấp quyền.
- **Hiệu năng cực cao**: Thời gian khởi động tính bằng microsecond, nhanh hơn rất nhiều so với việc spin-up một Docker container.
- **Viết bằng Rust**: Đảm bảo an toàn bộ nhớ và hiệu suất thực thi gần tương đương CPython.
- **Hỗ trợ Host Functions**: Cho phép định nghĩa các hàm an toàn từ phía ứng dụng chính (Host) để code trong sandbox gọi ra.
- **Snapshotting**: Hỗ trợ lưu trạng thái bộ nhớ để tạm dừng và tiếp tục thực thi sau này.

## Hướng dẫn cài đặt Local (macOS)

Để sử dụng Monty trên macOS, bạn có thể cài đặt trực tiếp qua pip hoặc uv (khuyến nghị dùng uv để quản lý package tốt hơn).

1. **Cài đặt Python 3.9+** (nếu chưa có):
   ```bash
   brew install python
   ```

2. **Cài đặt thư viện `pydantic-monty`**:
   ```bash
   pip install pydantic-monty
   # Hoặc nếu dùng uv:
   uv add pydantic-monty
   ```

3. **Kiểm tra cài đặt**:
   ```bash
   python -c "import pydantic_monty; print('Monty installed successfully')"
   ```

## Hướng dẫn Docker

Mặc dù Monty sinh ra để **thay thế** Docker trong việc sandbox code, nhưng bạn vẫn có thể cần đóng gói ứng dụng AI Agent của mình (có chứa Monty) bằng Docker. Dưới đây là Dockerfile cơ bản:

```dockerfile
# Sử dụng Python slim image để tối ưu dung lượng
FROM python:3.11-slim

# Thiết lập thư mục làm việc
WORKDIR /app

# Cài đặt dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
# Đảm bảo pydantic-monty có trong requirements.txt

# Copy mã nguồn ứng dụng
COPY . .

# Chạy ứng dụng
CMD ["python", "main.py"]
```

Build và Run:
```bash
# Build image
docker build -t my-ai-agent .
# Run container
docker run my-ai-agent
```

## Ví dụ Code (Example Code)

Dưới đây là ví dụ minh họa cách sử dụng Monty để chạy một đoạn code Python không tin cậy một cách an toàn. (Lưu ý: API có thể thay đổi do dự án đang phát triển nhanh).

```python
import asyncio
# Giả định import, tên module thực tế có thể là pydantic_monty
import pydantic_monty

async def run_safe_code():
    # Code được sinh ra bởi LLM (ví dụ: tính toán đơn giản)
    # Code này KHÔNG thể truy cập file hay mạng của máy bạn
    unsafe_code = """
result = 0
for i in range(10):
    result += i
print(f'Kết quả tính toán an toàn: {result}')
"""

    print("--- Bắt đầu thực thi trong Monty Sandbox ---")
    
    # Khởi tạo instance Monty với code cần chạy
    monty_instance = pydantic_monty.Monty(unsafe_code)
    
    # Thực thi code (API mẫu)
    # Monty sẽ chặn nếu code cố gắng import os hay truy cập disk
    await pydantic_monty.run_monty_async(monty_instance)
    
    print("--- Kết thúc thực thi ---")

if __name__ == "__main__":
    asyncio.run(run_safe_code())
```

### Sources
- [github.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQE2-A9Lz4dqZKIOZBq6eMnzLYIpcXVY-2xvMCIT8lrqQBchsS9pCNYhhYFWQ0rSXtH_8HQ8RyPE7oYMOVBmQ8gU0rQcIqZSYKkJKLBflFMi5sJ690hactj_pMgKb1GUcuYyRZ5BbAxhbrjpFdbTmHLbrGtQKGA=)
- [pydantic.dev](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFrvWmkHHMeXhTPC5ayW41FAiYxOMZn1ElrT2556zBR82JEtVxBbR1ZAnXTMji0MeIM4JX3lpO3-yKwBvWz9liiFiXYJ8GahSqaiZ1ZgIYAWdSVpUlBnyHR79rN)
- [github.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQEJzKZ_kOMQpxkllumY4DUbLxAZUYXGr8BROV7XwMgVVhmV-9xJyxBvHrvOXjU5QxpWURl7Ri4TK3dR1bZReCv7RPPuOzr8Zg1Gnn58x9Vgd4n4Gz_reoFhp82e)
- [simonwillison.net](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQGHvGs-59UN9x5aUYRvKjiPcNDdszICBJfv69mMVziHAlq4IHpmDAkarZgH7VNJaQVYXpx1yqlD_6epbMJJbWnY17-E71xf9vktoUlVSBvf2c7Q_iqOm8PW_ji-O1DdOw7jr498Hp-hNphGnMV6qw==)
- [ycombinator.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQGyb2bwJOxT4YvkUfLk2IhwkPDX0Xw5_3_3PaYYH86gwgig2tEAXI317RDobAzDglLDKAVfZ70L66wxwSfLeATUFRn2srfOSz32yZWs3oLeHFBsVCDBS-mSbMD_ktH209jl1p00yXRS)
- [substack.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQEivLmNIeww3lvz3oG-VpGYv8jI2iW6AbV34KW8H00I8kmD5PlHs7SNjm0dhJTe68Umav98mQPtOvzjVS_Wx8UlBztWYdUsZeinp8jcXXBvdjGoXV9zfLOvEauPgvgHvHuVaU_ruwtLgd9PKRp9J7n0s3f1V_3qp8GfZWI=)
- [daily.dev](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFMYcQgdlbgMdGzY1XAhRMbvi9HwC_feo34P0sbEZlOXx0Vmv71xbeybWZqp42HAP94mBIDR0bZmNqKTI_BdEPDK1hD511WqHpmyc_cSWm76HI7Nffl9ZZA9AZxNuV7gA==)
- [pydevtools.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQHn-il0FjE-P2BkDRbpPcomf_IEsXcbMxaafEI69Y_uwIboVN1kW1NHBA06N75bDcTle992cD6X6eLDQ1dJA5FOSozsk63gjgxQeZ7r_0OawCWLNS-UTCBwl6szu4_kyVyRgk8gPI3pbDt9_DD_HIzsdpvtjRS3U1Zzwr4yRfCz72Z9fIL3I6aYoTuUuD4=)
- [github.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQElOAZsxVpFtF4hqgxIodJx6UKST7kW-gvyQL0fha5YR2sftALCcd8hUE-_0zCUmjrgIe7HuL8aYc9dlM2xdt_l6-nuAL11TjoGKfeChpfqxILEyI863S_-kRv5-NOMDaQj)
- [github.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFne9-GnbFvEwZATRuxVap_Bhg_xQ3bcTGUqjoOP9ul_E3TK3n_6kjGNdTI5WYokTsf8rfFHUoqVShqwbJou_nlsIfM_AivqC9RmAWOJIPoRC3zm0FXX_aK69KGQ299zZe4XpAuRfkVYt0ix1ZWX0s=)
- [github.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQEGgO0bHw3IaTNPCpImeUIyrxMfv7PpBLPZskCxagbswKVQfu6wDMhh70c93ySno5RGjbYQILGfkMzfhapY1_eNrRzZgGzevOX2IgmTO_TZRLSDqbppnFQpjyDVw0zx6Tc8J73x0WkA1aK6rZuQtOr3ag==)
- [github.com](https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQHLmpAEJ-YaGjxY1FWHY6TWC6rVuY-__SKv-_cGBzEimMnWaRtlj2nfjzZColT2ltIkcobmrM1Rt1L6Dym0wlJHlSEB20HdaQYu9gwc_NE4H2i-D1rSJ0pdQfSyh1eSJ11hWxq0)


### Github Page 

https://github.com/pydantic/monty

